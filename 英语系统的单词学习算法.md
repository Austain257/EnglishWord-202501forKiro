## 📘 需求规格说明书：英语学习系统 —— 新词学习与八轮复习流程控制系统

### 一、核心目标
实现以 **30 分钟新词学习 + 两轮强制复习（10 分钟后 & 60 分钟后）** 为核心的最小记忆强化单元，并通过**状态锁机制**确保用户严格遵循科学复习节奏，防止跳过关键巩固环节。

---

### 二、功能模块定义

#### 1. **新词学习阶段（30分钟专注模式）**
- 用户进入“单词学习”界面后，用户选定范围之后点击启动 **30 分钟倒计时组件**（UI 显示为醒目圆形/线性倒计时，尺寸 ≥30dp，文案为‘开始学习’），组件需要添加容错机制，防止用户误触。
- 在这期间，用户学习开始学习新词

  - 用户的学习行为：先选中范围10个单词，进行多轮次的学习，之后用户切换至下一个范围，此处可以提供一个快捷按钮【下十个】

  - 当用户选中范围并点击【开始学习（计时按钮）】按钮，系统自动记录当前范围的**起始位置start_id**和**开始时间start_time**，直到本轮30分钟计时学习结束。

  - 用户重复以上学习行为，直至倒计时结束，此时系统应该提醒用户本轮倒计时结束，本次学习应该停止，开始第一轮复习；倒计时结束后，等待用户当前正在学习的范围学完，系统给出提示，并提供按钮【结束学习】，用户点击结束本次学习，此按钮为强制性按钮，用户必须点击此按钮才可以退出页面。

  - 倒计时结束后，显示 **【标记并结束本轮学习】** 按钮。

  - 点击后，系统执行：
    - 系统获取用户最后一轮学习范围的**结束位置end_id**和**结束时间end_time**；（此时i系统应该记录了计时开始时的起始位置start_id，还有结计时结束时的结束位置end_id）
    - 向 `word_study_record` 表插入一条记录，表的字段包含：
      - `id` 主键、自增。唯一标识
      - `user_id` 用户id，外键，关联用户表，标识是哪个用户的学习记录，非空
      - `start_time` 开始学习时间（用户点击“开始学习”时记录的开始时间）、非空
      - `start_id` 本轮学习单词范围的起始ID（计时开始时记录）、非空
      - `end_time` 实际结束时间（用户点击“结束学习”时记录的结束时间）、非空
      - `end_id` 本轮学习单词范围的结束ID（计时结束时记录）、非空
      - `status` 会话状态：`1`(进行中)/`0`(正常结束)/`4`(异常退出)。用于容错、非空
      - `create_time` 记录添加数据的时间，数据库默认当前时间
      - `update_time` 记录的最后一次修改时间修改时间

      - `round_1_review_time` 第一轮复习结束的时间（默认值null，表示未复习）
      - `round_2_review_time` 第二轮复习结束的时间（默认值null，表示未复习）
      - `round_3_review_time` 第三轮复习结束的时间（默认值null，表示未复习）
      - `round_4_review_time`  第四轮复习结束的时间（默认值null，表示未复习）
      - `round_5_review_time` 第五轮复习结束的时间（默认值null，表示未复习）
      - `round_6_review_time` 第六轮复习结束的时间（默认值null，表示未复习）
      - `round_7_review_time` 第七轮复习结束的时间（默认值null，表示未复习）
      - `round_8_review_time` 第八轮复习结束的时间（默认值null，表示未复习）

    - 给出鼓励性语言（可以从激励文案获取）和MVP计算画面，并提示用户马上开始第一轮复习

---

#### 2. **状态锁定与功能禁用机制**
- **触发条件**：当 `word_study_record` 中存在记录满足当天的记录  
  `round_1_review_time IS NULL OR round_2_review_time IS NULL`
- **系统行为**：
  - 全局弹出警告：“⚠️ 您有未完成的复习任务，请先完成第一、二轮复习！”
  - **禁用除“复习入口”外的所有主功能**（如新词学习、句子练习、设置等）；
  - 仅允许进入 **【复习中心】** 页面和使用插入【积累本】功能。

---

#### 3. **复习中心（已实现）**
进入复习页面后，提供两个选项卡：

| 选项卡         | 功能描述         | 复习形式                                                     |
| -------------- | ---------------- | ------------------------------------------------------------ |
| **第一轮复习** | 强制进行基础巩固 | 英译汉卡片式问答（无游戏化）                                 |
| **第二轮复习** | 进阶强化记忆     | **随机进入两种模式之一**：<br>• 单词选项<br>• 趣味单词小游戏 |

---

#### 4. **复习完成标记机制（未实现）**
- 在第一轮复习、第二列复习相关页面添加按钮，页面底部显示 **【标记本轮复习已完成】** 按钮。
- 点击后，系统更新 `word_study_record` 表对应字段：
  - 第一轮 → `round_1_review_time = NOW()`
  - 第二轮 → `round_2_review_time = NOW()`
- **仅当当天 `round_1_review_time` 和 `round_2_review_time` 均非空时**，全局功能解锁。

---

#### 5. **数据库设计：`word_study_record` 表（已创建）**
```sql
CREATE TABLE `word_study_record` (
  `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键，自增。唯一标识每次学习记录',
  `user_id` bigint UNSIGNED NOT NULL COMMENT '用户id，外键，关联用户表，标识是哪个用户的学习记录',
  `start_time` datetime NOT NULL COMMENT '开始学习时间（用户点击“开始学习”时记录）',
  `start_id` int UNSIGNED NOT NULL COMMENT '本轮学习单词范围的起始ID（计时开始时记录）',
  `end_time` datetime NOT NULL COMMENT '实际结束时间（用户点击“结束学习”时记录）',
  `end_id` int UNSIGNED NOT NULL COMMENT '本轮学习单词范围的结束ID（计时结束时记录）',
  `status` tinyint UNSIGNED NOT NULL DEFAULT 1 COMMENT '会话状态：1-进行中，0-正常结束，4-异常退出',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '记录添加数据的时间，默认当前时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '记录的最后一次修改时间',
  `round_1_review_time` datetime DEFAULT NULL COMMENT '第一轮复习结束的时间，NULL表示未复习',
  `round_2_review_time` datetime DEFAULT NULL COMMENT '第二轮复习结束的时间，NULL表示未复习',
  `round_3_review_time` datetime DEFAULT NULL COMMENT '第三轮复习结束的时间，NULL表示未复习',
  `round_4_review_time` datetime DEFAULT NULL COMMENT '第四轮复习结束的时间，NULL表示未复习',
  `round_5_review_time` datetime DEFAULT NULL COMMENT '第五轮复习结束的时间，NULL表示未复习',
  `round_6_review_time` datetime DEFAULT NULL COMMENT '第六轮复习结束的时间，NULL表示未复习',
  `round_7_review_time` datetime DEFAULT NULL COMMENT '第七轮复习结束的时间，NULL表示未复习',
  `round_8_review_time` datetime DEFAULT NULL COMMENT '第八轮复习结束的时间，NULL表示未复习',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户单词学习记录表';
```
> 💡 **扩展性**：预留 8 个复习字段，支持未来扩展完整艾宾浩斯八轮复习。

---

#### 6. **每日学习清单自动生成（定时任务）**
- **触发时机**：每日凌晨 2:00（后端实现定时器执行）

- **逻辑**：

  - 查询前一天日（按 `create_time` 日期分组）所有 `word_study_record` 记录；
  - 根据同一天的学习数据，取最早的start_id和最晚的end_id组成一条清单记录，格式为：学习新单词范围从start_id到end_id，并将其插入数据库表learning_checklist，注意清单类型要标记为1
  - 插入 `learning_checklist` 表，`created_time` = 前一天的下午15点`；

  **学习清单表`learning_checklist`** 结构如下：

  ```
  create table learning_checklist
  (
      id               int auto_increment comment '清单/计划编号'
          primary key,
      user_id          bigint   default 0                 not null comment '用户编号(默认0管理员)',
      learning_record  varchar(100)                       not null comment '学习记录',
      type             tinyint                            not null comment '学习类型（0句子/1单词/2听力）',
      selected         tinyint  default 0                 not null comment '选中今天的复习内容',
      already_reviewed tinyint  default 0                 not null comment '今日已经复习',
      create_time      datetime default CURRENT_TIMESTAMP not null comment '创建时间',
      update_time      datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
      constraint fk_checklist_user
          foreign key (user_id) references users (id)
              on delete cascade
  )
      comment '学习清单' collate = utf8mb4_general_ci;
  
  create index idx_already_reviewed
      on learning_checklist (already_reviewed);
  
  create index idx_create_time
      on learning_checklist (create_time);
  
  create index idx_selected
      on learning_checklist (selected);
  
  create index idx_type
      on learning_checklist (type);
  
  create index idx_user_id
      on learning_checklist (user_id);
  ```

  

---

#### 7. **隔日未完成复习的强制处理（此功能需求未想好，暂时不实现）**
- 当天晚上进行第三轮复习，并将当晚觉得未掌握的单词添加至临时错词表`temporary_word_error`
- 第三轮复习页面与上面提到的第一轮复习页面是同一个，需要为第一轮复习的页面修改：当进入该页面时查询当前时间大于当天的18：00，则将【未掌握】按钮的插入路径改为“”，区别于原本的错词登记路径，携带参数一致
- **场景**：用户未完成当天最后一轮复习即退出。
- **系统行为**：
  - 在用户退出前，若检测到存在 `study_session` 记录中 **最高轮次复习未完成**，则向 `pending_review_tasks` 表插入临时任务。
- **次日登录检查**：
  - 系统启动时查询 `pending_review_tasks`；
  - 若存在记录，则 **强制弹窗**：“您有昨日未完成的复习，请优先完成！”
  - **锁定所有功能**，直至用户完成该任务并点击【标记完成】。

---

### 三、非功能性要求

1. **实时性**：每次页面加载/刷新时，必须校验 `word_study_record` 状态并执行锁逻辑。
2. **数据一致性**：复习时间字段更新需保证原子性（使用数据库事务）。
3. **用户体验**：
   - 倒计时组件需有视觉反馈（颜色渐变、震动提醒等）；
   - 锁定状态需提供明确引导（如高亮复习入口按钮）。
4. **可扩展性**：复习轮次、时间间隔应支持配置化（未来可调整为完整八轮）。

---

### 四、状态流转图（简化版）

```
graph TD
  A[开始30分钟新词学习] --> B{30分钟结束?}
  B -->|是| C[标记学习完成 → 写入word_study_record]
  C --> D{round_1 & round_2 完成?}
  D -->|否| E[全局功能锁定]
  E --> F[进入复习中心]
  F --> G[完成第一轮 → 更新round_1_time]
  F --> H[完成第二轮 → 更新round_2_time]
  G & H --> I{两轮均完成?}
  I -->|是| J[解锁全部功能]
  I -->|否| E
```

