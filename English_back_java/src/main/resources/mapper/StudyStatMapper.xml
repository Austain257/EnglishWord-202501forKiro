<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.austain.mapper.StudyStatMapper">

    <insert id="upsertDailyStats">
        INSERT INTO user_study_daily (user_id, stat_date, total_sec, updated_at)
        VALUES (#{userId}, #{statDate}, #{totalSec}, #{updatedAt})
        ON DUPLICATE KEY UPDATE total_sec  = total_sec + #{totalSec},
                                updated_at = #{updatedAt}
    </insert>


    <insert id="upsertTotalStats">
        INSERT INTO user_study_summary (user_id, total_sec, updated_at)
        VALUES (#{userId}, #{totalSec}, #{updatedAt})
        ON DUPLICATE KEY UPDATE total_sec  = total_sec + #{totalSec},
                                updated_at = #{updatedAt}
    </insert>


    <insert id="initUserStats">
        INSERT IGNORE INTO user_study_summary (user_id, total_sec, updated_at)
        VALUES (#{userId}, 0, NOW())
    </insert>


    <select id="findRecentStats" resultType="com.austain.domain.po.UserStudyDaily">
        SELECT *
        FROM user_study_daily
        WHERE user_id = #{userId}
          AND stat_date >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY stat_date DESC
    </select>


    <select id="countStudyDays" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM (SELECT stat_date FROM user_study_daily WHERE user_id = #{userId} AND total_sec > 0 GROUP BY stat_date) t
    </select>
</mapper>
